NIP-57
======

闪电 Zaps
---------

`草案` `可选` `作者:jb55` `作者:kieran`

此 NIP 定义了两种新的事件类型，用于记录用户之间的闪电支付。`9734` 是一个 `zap 请求`，代表付款人向收款人的闪电钱包请求发票。`9735` 是一个 `zap 收据`，代表收款人的闪电钱包确认对 `zap 请求` 发出的发票已付款。

在 nostr 上有闪电收据，允许客户端显示来自网络实体的闪电支付。这可以用于娱乐或防止垃圾信息。

## 协议流程

1. 客户端从被 zapped 的事件的 `zap` 标签（见附录 G）计算收款人的 lnurl 支付请求 url，或者根据 [lnurl 规范](https://github.com/lnurl/luds)解码他们个人资料上的 lud06 或 lud16 字段。客户端**必须**向此 url 发送 GET 请求并解析响应。如果 `allowsNostr` 存在并且为 `true`，并且如果 `nostrPubkey` 存在并且是十六进制的有效 BIP 340 公钥，客户端应将此信息与用户关联，以及响应的 `callback`，`minSendable` 和 `maxSendable` 值。
2. 客户端可以选择在每个贴文或用户个人资料上显示一个闪电 zap 按钮。如果用户的 lnurl 支付请求端点支持 nostr，客户端**应该**使用此 NIP 请求 `zap 收据`，而不是正常的 lnurl 发票。
3. 当用户（“发送者”）表示他们想要向另一个用户（“接收者”）发送 zap 时，客户端应创建一个 `zap 请求`事件，如本 NIP 的附录 A 所述，并对其进行签名。
4. 应该使用 GET 请求发送一个 `9734` 事件而不是 `zap 请求` 到从 lnurl 支付端点收到的接收者 `callback` url。有关详细信息和示例，请参见附录 B。
5. 接收者的 lnurl 服务器将接收 `zap 请求`并验证它。有关如何正确配置 lnurl 服务器以支持 zaps 的详细信息，请参见附录 C，有关如何验证 `nostr` 查询参数的详细信息，请参见附录 D。
6. 如果 `zap 请求`有效，服务器应获取描述哈希发票，也就是这个 `zap 请求`贴文描述。描述中不包含其他 lnurl 元数据。这将根据 [LUD06](https://github.com/lnurl/luds/blob/luds/06.md) 在响应中返回。
7. 收到发票后，客户端**可以**支付它，或者将其传递给可以支付发票的应用程序。
8. 一旦发票被支付，接收者的 lnurl 服务器**必须**生成一个 `zap 收据`，如附录 E 所述，并将其发布到 `zap 请求`中指定的 `relays`。
9. 客户端**可以**在贴文或个人资料上获取 `zap 收据`，但**必须**按照附录 F 所述验证其有效性。如果 `zap 请求`贴文包含非空的 `content`，可以显示一个 zap 评论。通常客户端应向用户显示 `zap 请求`贴文，并使用 `zap 收据` 显示“zap 由...授权”，但这是可选的。

## 参考和示例

### 附录 A：Zap 请求事件

`zap 请求`是一种 `9734` 类型的事件，它 _不_ 被发布到中继，而是发送到接收者的 lnurl 支付 `callback` url。此事件的 `content` **可以**是随付款发送的可选消息。事件**必须**包括以下标签：

- `relays` 是接收者钱包应将其`zap 收据`发布到的中继列表。请注意中继不应嵌套在额外的列表中，而应按照下面的示例所示包含。
- `amount` 是发送者打算支付的 _millisats_ 金额，格式为字符串。这是推荐的，但是可选的。
- `lnurl` 是接收者的 lnurl 支付 url，使用前缀 `lnurl` 的 bech32 编码。这是推荐的，但是可选的。
- `p` 是接收者的十六进制编码公钥。

此外，事件**可以**包括以下标签：

- `e` 是可选的十六进制编码事件 id。如果对事件进行 zapping 而不是对人进行 zapping，客户端**必须**包含此内容。
- `a` 是一个可选的 NIP-33 事件坐标，允许对参数化可替换事件（如 NIP-23 长格式贴文）进行打赏。

示例：

```json
{
  "kind": 9734,
  "content": "Zap!",
  "tags": [
    ["relays", "wss://nostr-pub.wellorder.com", "wss://anotherrelay.example.com"],
    ["amount", "21000"],
    ["lnurl", "lnurl1dp68gurn8ghj7um5v93kketj9ehx2amn9uh8wetvdskkkmn0wahz7mrww4excup0dajx2mrv92x9xp"],
    ["p", "04c915daefee38317fa734444acee390a8269fe5810b2241e5e6dd343dfbecc9"],
    ["e", "9ae37aa68f48645127299e9453eb5d908a0cbb6058ff340d528ed4d37c8994fb"]
  ],
  "pubkey": "97c70a44366a6535c145b333f973ea86dfdc2d7a99da618c40c64705ad98e322",
  "created_at": 1679673265,
  "id": "30efed56a035b2549fcaeec0bf2c1595f9a9b3bb4b1a38abaf8ee9041c4b7d93",
  "sig": "f2cb581a84ed10e4dc84937bd98e27acac71ab057255f6aa8dfa561808c981fe8870f4a03c1e3666784d82a9c802d3704e174371aa13d63e2aeaf24ff5374d9d"
}
```

### 附录 B：Zap 请求 HTTP 请求

签名的 `zap 请求`事件不会被发布，而是通过 HTTP GET 请求发送到接收者的 `callback` url，该 url 由接收者的 lnurl 支付端点提供。此请求应定义以下查询参数：

- `amount` 是发送者打算支付的 _millisats_ 金额
- `nostr` 是 `9734` `zap 请求` 事件，先进行 JSON 编码，然后进行 URI 编码
- `lnurl` 是接收者的 lnurl 支付 url，使用前缀 `lnurl` 的 bech32 编码

此请求应返回一个带有 `pr` 键的 JSON 响应，该键是发送者必须支付以完成其 zap 的发票。以下是 javascript 中的示例流程：

```javascript
const senderPubkey // 发送者的公钥
const recipientPubkey = // 接收者的公钥
const callback = // 来自接收者 lnurl 支付端点的回调
const lnurl = // 接收者的闪电网络地址，编码为 lnurl
const sats = 21

const amount = sats * 1000
const relays = ['wss://nostr-pub.wellorder.net']
const event = encodeURI(JSON.stringify(await signEvent({
  kind: 9734,
  content: "",
  pubkey: senderPubkey,
  created_at: Math.round(Date.now() / 1000),
  tags: [
    ["relays", ...relays],
    ["amount", amount.toString()],
    ["lnurl", lnurl],
    ["p", recipientPubkey],
  ],
})))

const {pr: invoice} = await fetchJson(`${callback}?amount=${amount}&nostr=${event}&lnurl=${lnurl}`)
```

### 附录 C：LNURL 服务器配置

lnurl 服务器将需要一些额外的信息，以便客户端知道支持 zap 发票：

1. 在 lnurl-pay 静态端点 `/.well-known/lnurlp/<user>` 中添加一个 `nostrPubkey`，其中 `nostrPubkey` 是服务器将用于签署 `zap 收据`事件的 nostr 公钥。客户端将使用此信息验证 `zap 收据`。
2. 添加一个 `allowsNostr` 字段并将其设置为 true。

### 附录 D：LNURL 服务器 Zap 请求验证

当客户端将 `zap 请求`事件发送到服务器的 lnurl-pay 回调 URL 时，将有一个 `nostr` 查询参数，其值是 URI 和 JSON 编码的该事件。如果存在，必须以以下方式验证 `zap 请求`事件：

1. 它**必须**有一个有效的 nostr 签名
2. 它**必须**有标签
3. 它**必须**只有一个 `p` 标签
4. 它**必须**有 0 或 1 个 `e` 标签
5. 应该有一个 `relays` 标签，其中包含要发送 `zap 收据`的中继。
6. 如果有一个 `amount` 标签，它**必须**等于 `amount` 查询参数。
7. 如果有一个 `a` 标签，它**必须**是一个有效的 NIP-33 事件坐标

当发票付款后，**必须**存储事件以供以后使用。

### 附录 E：Zap 收据事件

当由 `zap 请求`生成的发票付款时，闪电节点会创建一个 `zap 收据`。只有当发票描述（提交给描述哈希）包含 `zap 请求`贴文时，才会创建 `Zap 收据`。

收到付款时，执行以下步骤：

1. 获取发票的描述。在生成描述哈希发票期间需要保存它。这里使用的参考实现 CLN 会自动保存。
2. 将 bolt11 描述解析为 JSON nostr 事件。在接收时或在发票付款前，**应该**根据附录 D 中的要求进行验证。
3. 创建一种 `9735` 类型的 nostr 事件，如下所述，并将其发布到 `zap 请求`中声明的 `relays`。

`zap 收据`事件：

- `content` **应该**为空。
- `created_at` 日期**应该**设置为发票 `paid_at` 日期以保证幂等性。
- `tags` **必须**包括来自 `zap 请求`的 `p` 标签**以及**可选的 `e` 标签**以及**来自 `zap 请求`的可选的 `a` 标签。
- `zap 收据`**必须**有一个 `bolt11` 标签，其中包含描述哈希 bolt11 发票。
- `zap 收据`**必须**包含一个 `description` 标签，该标签是 JSON 编码的发票描述。
- `SHA256(description)` **必须**与 bolt11 发票中的描述哈希匹配。
- `zap 收据`**可以**包含一个 `preimage` 标签，以匹配 bolt11 发票的付款哈希。这并不真正是付款证明，没有真正的方式证明发票是真实的或已经付款。你将信任 `zap 收据`的作者对付款的合法性。

`zap 收据`不是付款证明，它只证明了某个 nostr 用户获取了发票。`zap 收据`的存在暗示了发票已付款，但如果有一个流氓实现，它可能是一个谎言。

可以在[这里](https://github.com/jb55/cln-nostr-zapper)找到 zap 启用的 lnurl 服务器的参考实现。

示例`zap收据`：

```json
{
    "id": "67b48a14fb66c60c8f9070bdeb37afdfcc3d08ad01989460448e4081eddda446",
    "pubkey": "9630f464cca6a5147aa8a35f0bcdd3ce485324e732fd39e09233b1d848238f31",
    "created_at": 1674164545,
    "kind": 9735,
    "tags": [
      ["p", "32e1827635450ebb3c5a7d12c1f8e7b2b514439ac10a67eef3d9fd9c5c68e245"],
      ["e", "3624762a1274dd9636e0c552b53086d70bc88c165bc4dc0f9e836a1eaf86c3b8"],
      ["bolt11", "lnbc10u1p3unwfusp5t9r3yymhpfqculx78u027lxspgxcr2n2987mx2j55nnfs95nxnzqpp5jmrh92pfld78spqs78v9euf2385t83uvpwk9ldrlvf6ch7tpascqhp5zvkrmemgth3tufcvflmzjzfvjt023nazlhljz2n9hattj4f8jq8qxqyjw5qcqpjrzjqtc4fc44feggv7065fqe5m4ytjarg3repr5j9el35xhmtfexc42yczarjuqqfzqqqqqqqqlgqqqqqqgq9q9qxpqysgq079nkq507a5tw7xgttmj4u990j7wfggtrasah5gd4ywfr2pjcn29383tphp4t48gquelz9z78p4cq7ml3nrrphw5w6eckhjwmhezhnqpy6gyf0"],
      ["description", "{\"pubkey\":\"32e1827635450ebb3c5a7d12c1f8e7b2b514439ac10a67eef3d9fd9c5c68e245\",\"content\":\"\",\"id\":\"d9cc14d50fcb8c27539aacf776882942c1a11ea4472f8cdec1dea82fab66279d\",\"created_at\":1674164539,\"sig\":\"77127f636577e9029276be060332ea565deaf89ff215a494ccff16ae3f757065e2bc59b2e8c113dd407917a010b3abd36c8d7ad84c0e3ab7dab3a0b0caa9835d\",\"kind\":9734,\"tags\":[[\"e\",\"3624762a1274dd9636e0c552b53086d70bc88c165bc4dc0f9e836a1eaf86c3b8\"],[\"p\",\"32e1827635450ebb3c5a7d12c1f8e7b2b514439ac10a67eef3d9fd9c5c68e245\"],[\"relays\",\"wss://relay.damus.io\",\"wss://nostr-relay.wlvs.space\",\"wss://nostr.fmt.wiz.biz\",\"wss://relay.nostr.bg\",\"wss://nostr.oxtr.dev\",\"wss://nostr.v0l.io\",\"wss://brb.io\",\"wss://nostr.bitcoiner.social\",\"ws://monad.jb55.com:8080\",\"wss://relay.snort.social\"]]}"],
      ["preimage", "5d006d2cf1e73c7148e7519a4c68adc81642ce0e25a432b2434c99f97344c15f"]
    ],
    "content": "",
    "sig": "b0a3c5c984ceb777ac455b2f659505df51585d5fd97a0ec1fdb5f3347d392080d4b420240434a3afd909207195dac1e2f7e3df26ba862a45afd8bfe101c2b1cc"
  }
```

### 附录 F：验证 Zap 收据

客户端可以使用 NIP-01 过滤器检索事件和 pubkeys 上的 `zap 收据`，例如 `{"kinds": [9735], "#e": [...]}`。**必须**使用以下步骤验证 Zaps：

- `zap 收据`事件的 `pubkey` **必须**与接收者的 lnurl 提供者的 `nostrPubkey` 相同（在协议流程的步骤1中检索）。
- `zap 收据`的 `bolt11` 标签中包含的 `invoiceAmount` **必须**等于 `zap 请求`的 `amount` 标签（如果存在）。
- `zap 请求`的 `lnurl` 标签（如果存在）**应该**等于接收者的 `lnurl`。

### 附录 G：其他事件上的 `zap` 标签

当一个事件包含一个或多个 `zap` 标签时，希望 zap 它的客户端**应该**根据标签值计算 lnurl 支付请求，而不是事件作者的个人资料字段。标签的第 2 参数是接收者公钥的 `hex` 字符串，第 3 参数是下载接收者元数据（Kind-0）的中继。一个可选的第 4 参数指定了分配给相应接收者的权重（通用百分比）。客户端应解析所有权重，计算总和，然后给每个接收者一个百分比。如果没有权重，客户端应将 zap 金额平均分配给所有接收者。如果权重只部分存在，没有权重的接收者不应被 zap（`weight = 0`）。

```js
{
    "tags": [
        [ "zap", "82341f882b6eabcd2ba7f1ef90aad961cf074af15b9ef44a09f9d2a8fbfbe6a2", "wss://nostr.oxtr.dev", "1" ],  // 25%
        [ "zap", "fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52", "wss://nostr.wine/",    "1" ],  // 25%
        [ "zap", "460c25e682fda7832b52d1f22d3d22b3176d972f60dcdc3212ed8c92ef85065c", "wss://nos.lol/",       "2" ]   // 50%
    ]
}
```

客户端**可以**在贴文中显示 zap 分配设置。

## 后续工作

通过将 `zap 请求`贴文加密给目标用户，可以将 Zaps 扩展为私密，但为了简单起见，在本草案中被省略。
