NIP-98
======

HTTP 授权
---------

`草案` `可选` `作者:kieran` `作者:melvincarvalho`

本 NIP 借由 nostr 事件定义了一个用于授权对 HTTP 服务器的请求的短暂事件。

这对于为 Nostr 构建并处理 Nostr 用户账户的 HTTP 服务非常有用。

## Nostr 事件

使用 `kind 27235`（参考 [RFC 7235](https://www.rfc-editor.org/rfc/rfc7235)）事件。

`content` **应该**为空。

**必须**包含以下标签。

* `u` - 绝对 URL
* `method` - HTTP 请求方法

示例事件：

```json
{
    "id": "fe964e758903360f28d8424d092da8494ed207cba823110be3a57dfe4b578734",
    "pubkey": "63fe6318dc58583cfe16810f86dd09e18bfd76aabc24a0081ce2856f330504ed",
    "content": "",
    "kind": 27235,
    "created_at": 1682327852,
    "tags": [
        [
            "u",
            "https://api.snort.social/api/v1/n5sp/list"
        ],
        [
            "method",
            "GET"
        ]
    ],
    "sig": "5ed9d8ec958bc854f997bdc24ac337d005af372324747efe4a00e24f4c30437ff4dd8308684bed467d9d6be3e5a517bb43b1732cc7d33949a3aaf86705c22184"
}
```

服务器**必须**执行以下检查以验证事件：
1. `kind` **必须**为 `27235`。
2. `created_at` 时间戳**必须**在合理的时间窗口内（建议60秒）。
3. `u` 标签**必须**与请求的绝对 URL（包括查询参数）完全相同。
4. `method` 标签**必须**与请求资源所使用的 HTTP 方法相同。

当请求包含主体（如在 POST/PUT/PATCH 方法中）时，客户端**应该**在 `payload` 标签中包含请求主体的 SHA256 哈希值作为十六进制（`["payload", "<sha256-hex>"]`），服务器**可以**检查此项以验证请求的有效载荷是否已授权。

如果其中一项检查失败，服务器**应该**以 401 未授权的响应代码进行响应。

服务器**可以**执行额外实现的特定的验证检查。

## 请求流程

使用 `Authorization` HTTP 头，`kind 27235` 事件**必须**进行 `base64` 编码，并使用 `Nostr` 授权协议。

示例 HTTP 授权头：

```
Authorization: Nostr eyJpZCI6ImZlOTY0ZTc1ODkwMzM2MGYyOGQ4NDI0ZDA5MmRhODQ5NGVkMjA3Y2JhODIzMTEwYmUzYTU3ZGZlNGI1Nzg3MzQiLCJwdWJrZXkiOiI2M2ZlNjMxOGRjNTg1ODNjZmUxNjgxMGY4NmRkMDllMThiZmQ3NmFhYmMyNGEwMDgxY2UyODU2ZjMzMDUwNGVkIiwiY29udGVudCI6IiIsImtpbmQiOjI3MjM1LCJjcmVhdGVkX2F0IjoxNjgyMzI3ODUyLCJ0YWdzIjpbWyJ1cmwiLCJodHRwczovL2FwaS5zbm9ydC5zb2NpYWwvYXBpL3YxL241c3AvbGlzdCJdLFsibWV0aG9kIiwiR0VUIl1dLCJzaWciOiI1ZWQ5ZDhlYzk1OGJjODU0Zjk5N2JkYzI0YWMzMzdkMDA1YWYzNzIzMjQ3NDdlZmU0YTAwZTI0ZjRjMzA0MzdmZjRkZDgzMDg2ODRiZWQ0NjdkOWQ2YmUzZTVhNTE3YmI0M2IxNzMyY2M3ZDMzOTQ5YTNhYWY4NjcwNWMyMjE4NCJ9
```

## 参考实现

- C# ASP.NET `AuthenticationHandler` [NostrAuth.cs](https://gist.github.com/v0l/74346ae530896115bfe2504c8cd018d3)
