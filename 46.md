NIP-46
======

Nostr Connect
-------------

`草案` `可选` `作者:tiero` `作者:giowe` `作者:vforvalerio87`

## 原理

私钥应尽可能少地暴露给系统 - 应用程序，操作系统，设备 - 因为每个系统都会增加攻击面。

输入私钥也可能很烦人，并且需要将它们暴露给更多的系统，如操作系统的剪贴板，这可能被恶意应用程序监视。

## 术语

* **应用程序**：在任何平台上的 Nostr 应用程序，需要代表 Nostr 账户进行操作。
* **签名者**：持有 Nostr 账户的私钥的 Nostr 应用程序，可以代表其进行签名。

## `简而言之`

**应用程序**和**签名者**使用种类 `24133` 向彼此发送临时加密消息，使用选择的中继。

应用程序提示签名者执行诸如获取公钥或签名事件等操作。

`content` 字段必须是加密的 JSONRPC **请求**或**响应**。

## 签名者协议

### 消息

#### 请求

```json
{
  "id": <random_string>,
  "method": <one_of_the_methods>,
  "params": [<anything>, <else>]
}
```

#### 响应

```json
{
  "id": <request_id>,
  "result": <anything>,
  "error": <reason>
}
```

### 方法

#### 必选的

这些是远程签名者应用程序**必须**实现的方法：

- **describe**
  - 参数 []
  - 结果 `["describe", "get_public_key", "sign_event", "connect", "disconnect", "delegate", ...]`  
- **get_public_key**
  - 参数 []
  - 结果 `pubkey` 
- **sign_event**
  - 参数 [`event`]
  - 结果 `event_with_signature` 

#### 可选的

- **connect**
  - 参数 [`pubkey`]
- **disconnect**
  - 参数 []
- **delegate** 
  - 参数 [`delegatee`, `{ kind: number, since: number, until: number }`]
  - 结果 `{ from: string, to: string, cond: string, sig: string }`
- **get_relays**
  - 参数 []
  - 结果 `{ [url: string]: {read: boolean, write: boolean} }` 
- **nip04_encrypt**
  - 参数 [`pubkey`, `plaintext`]
  - 结果 `nip4 ciphertext`
- **nip04_decrypt**
  - 参数 [`pubkey`, `nip4 ciphertext`]
  - 结果 [`plaintext`]

注意：`pubkey` 和 `signature` 是十六进制编码的字符串。

### Nostr Connect URI

**签名者**通过扫描二维码，点击 deep link 或复制粘贴 URI 来发现**应用程序**。

**应用程序**生成一个带有前缀 `nostrconnect://` 和十六进制编码的 `pubkey` 作为基本路径的特殊 URI，以下是 **URL 编码**的查询字符串参数

- `relay` **应用程序**连接的中继的 URL，**签名者**必须在此发送和监听消息。
- `metadata`  **应用程序**的元数据 JSON
  - `name` **应用程序**的人类可读名称
  - `url` (可选) 请求连接的网站的 URL
  - `description` (可选) **应用程序**的描述
  - `icons` (可选) **应用程序**图标的 URL 数组。

#### JavaScript

```js
const uri = `nostrconnect://<pubkey>?relay=${encodeURIComponent("wss://relay.damus.io")}&metadata=${encodeURIComponent(JSON.stringify({"name": "Example"}))}`
```

#### 示例

```sh
nostrconnect://b889ff5b1513b641e2a139f661a661364979c5beee91842f8f0ef42ab558e9d4?relay=wss%3A%2F%2Frelay.damus.io&metadata=%7B%22name%22%3A%22Example%22%7D
```

## 流程

`content` 字段包含由 [NIP04](https://github.com/nostr-protocol/nips/blob/master/04.md) 指定的加密消息。选择的 `kind` 是 `24133`。

### 连接

1. 用户在网站上点击 **"连接"**按钮或使用二维码扫描
2. 它将显示一个 URI，用于打开启用了“nostr connect”的**签名者**
3. URI 中有**应用程序**的 pubkey，即 `nostrconnect://<pubkey>&relay=<relay>&metadata=<metadata>`
4. **签名者**将发送一条消息以 ACK `connect` 请求，同时附带他的公钥

### 断开连接（来自应用程序）

1. 用户在**应用程序**上点击 **"断开连接"**按钮
2. **应用程序**将向**签名者**发送一条带有 `disconnect` 请求的消息
3. **签名者**将发送一条消息以 ACK `disconnect` 请求

### 断开连接（来自签名者）

1. 用户在**签名者**上点击 **"断开连接"**按钮
2. **签名者**将向**应用程序**发送一条带有 `disconnect` 请求的消息

### 获取公钥

1. **应用程序**将向**签名者**发送一条带有 `get_public_key` 请求的消息
3. **签名者**将回送一条消息，其中包含公钥，作为对 `get_public_key` 请求的响应

### 签名事件

1. **应用程序**将向**签名者**发送一条带有 `sign_event` 请求的消息，以及需要签名的**事件**
2. **签名者**将向用户显示一个弹出窗口，以查看事件并签名
3. **签名者**将回送一条消息，其中包含事件，包括 `id` 和 schnorr `signature`，作为对 `sign_event` 请求的响应

### 委托

1. **应用程序**将向**签名者**发送一条带有元数据的消息，其中包含 `delegate` 请求，以及**条件**查询字符串和要委托的**应用程序**的 **pubkey**。
2. **签名者**将向用户显示一个弹出窗口，以委托**应用程序**代表他签名
3. **签名者**将回送一条消息，其中包含已签名的 [NIP-26 委托令牌](https://github.com/nostr-protocol/nips/blob/master/26.md)，或者拒绝它
