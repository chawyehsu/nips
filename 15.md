NIP-15
======

Nostr 市场（弹性市场）
---------------------

`草案` `可选` `作者:fiatjaf` `作者:benarc`  `作者:motorina0` `作者:talvasconcelos`

> 基于 https://github.com/lnbits/Diagon-Alley

> 已在 [NostrMarket](https://github.com/lnbits/nostrmarket) 和 [Plebeian Market](https://github.com/PlebeianTech/plebeian-market) 中实现

## 术语

- `商家` - 拥有 NOSTR 密钥对的产品销售者
- `客户` - 拥有 NOSTR 密钥对的产品购买者
- `产品` - `商家`出售的商品
- `摊位` - `商家`控制的产品列表（一个`商家`可以有多个摊位）
- `市场` - 用于搜索`摊位`和购买`产品`的客户端软件

## Nostr 市场客户端

### 商家管理

`商家`在此创建、更新和删除`摊位`和`产品`，以及管理销售、支付和与`客户`的沟通。

`商家`管理软件可以完全是客户端的，但出于`便利`和正常运行时间，实现可能会有一个服务器客户端监听 NOSTR 事件。

### 市场

`市场`软件应完全是客户端的，可以是一个独立的应用，也可以是一个纯前端网页。`客户`订阅不同的商家 NOSTR 公钥，那些`商家`的`摊位`和`产品`就会被列出并可搜索。市场客户端就像任何其他电子商务网站，有购物篮和结账功能。`市场`也可能希望包括一个`客户`支持区域，用于与`商家`私信沟通。

## `商家`发布/更新产品（事件）

商家可以发布这些事件：

| 类型    |                  | 描述                                    |
| ------- | ---------------- | --------------------------------------- |
| `0    ` | `set_meta`       | 商家描述（类似于任何 `nostr` 公钥）。   |
| `30017` | `set_stall`      | 创建或更新摊位。                        |
| `30018` | `set_product`    | 创建或更新产品。                        |
| `4    ` | `direct_message` | 与客户沟通。消息可以是纯文本或 JSON。   |
| `5    ` | `delete`         | 删除产品或摊位。                        |

### 事件 `30017`：创建或更新摊位

**事件内容**:

```json
{
    "id": <字符串, 商家生成的 UUID。不建议使用顺序 ID（`0`，`1`，`2`...）>,
    "name": <字符串, 摊位名称>,
    "description": <字符串（可选）, 摊位描述>,
    "currency": <字符串, 使用的货币>,
    "shipping": [
        {
            "id": <字符串, 商家生成的物流区域的 UUID>,
            "name": <字符串（可选）, 区域名称>,
            "cost": <浮点数, 物流的基本费用。货币在摊位级别定义>,
            "regions": [<字符串, 包含在此区域的地区>],
        }
    ]
}
```

不是自解释的字段：
 - `shipping`：
     - 这个摊位可能的物流区域的数组。
     - 客户必须准确选择其中一个物流区域。
     - 向不同区域物流可能有不同的费用。对于一些商品（例如数字商品），费用可以为零。
     - `id` 是商家使用的内部值。这个值必须作为客户选择发送回来。
     - 每个物流区域包含对该物流区域订单的基本费用，但如果该产品的物流费用高于基本费用所指定的费用，也可以指定特定的产品物流费用。

**事件标签**：

```json
  "tags": [["d", <String, id of stall]]
```

- `d` 标签是必需的，其值**必须**与摊位 `id` 相同。

### 事件 `30018`：创建或更新产品

**事件内容**：

```json
{
    "id": <字符串, 商家生成的 UUID。不建议使用顺序ID（`0`，`1`，`2`...）>,
    "stall_id": <字符串, 该产品所属的摊位的 UUID>,
    "name": <字符串, 产品名称>,
    "description": <字符串（可选）, 产品描述>,
    "images": <[字符串], 图片 URL 数组，可选>,
    "currency": <字符串, 使用的货币>,
    "price": <浮点数, 产品的成本>,
    "quantity": <整数, 可用的项目>,
    "specs": [
        [<字符串, 规格键>, <字符串, 规格值>]
    ],
    "shipping": [
        {
            "id": <字符串, 物流区域的 UUID。必须与摊位定义的区域之一匹配>,
            "cost": <浮点数, 物流的额外费用。货币在摊位级别定义>,
        }
    ]
}
```

不是自解释的字段：
 - `specs`：
     - 一个可选的键值对数组。它允许客户端用户界面以结构化模式展示产品规格。它还允许比较不同产品
     - 例如：`[["operating_system", "Android 12.0"], ["screen_size", "6.4 inches"], ["connector_type", "USB Type C"]]`
     
        _开放问题_：是否最好将 `spec` 移动到事件的 `tags` 部分？

- `shipping`：
     - 一个 _可选_ 的额外费用数组，仅用于需要将特殊物流费用添加到摊位定义的基本物流费用的产品
     - `id` 应与摊位的 `shipping` 字段中定义的物流区域的 id 匹配
     - 要计算订单的总物流费用，用户将在结账时选择一个物流选项，然后客户端必须考虑这些费用：
         - 选择的物流选项的`摊位的基本费用`
         - 如果有的话，将产品单位乘以`产品中指定的物流费用`的结果。

**事件标签**：

```json
  "tags": [
       ["d", <String, id of product],
       ["t", <String (optional), product category],
       ["t", <String (optional), product category],
       ...
    ]
```

 - `d` 标签是必需的，其值必须与产品 `id` 相同。
 - `t` 标签是可搜索的标签，它代表产品可以属于的不同类别（`食品`，`水果`）。可以存在多个 `t` 标签。

## 结账事件

所有结账事件都使用 [NIP04](https://github.com/nostr-protocol/nips/blob/master/04.md) 发送为 JSON 字符串。

`商家`和`客户`可以交换代表不同操作的 JSON 消息。每个 `JSON` 消息**必须**有一个 `type` 字段，表示 JSON 代表的内容。可能的类型：

| 消息类型 | 发送者 | 描述         |
| -------- | ------ | ------------ |
| 0        | 客户   | 新订单       |
| 1        | 商家   | 支付请求     |
| 2        | 商家   | 订单状态更新 |

### 步骤 1：`客户`订单（事件）

以下 json 放在 [NIP04](https://github.com/nostr-protocol/nips/blob/master/04.md) 的 `content` 中。

```json
{
    "id": <字符串, 客户生成的 UUID>,
    "type": 0,
    "name": <字符串（可选）, ???>,
    "address": <字符串（可选）, 对于实物商品，应提供地址>
    "message": <字符串（可选）, 给商家的消息>,
    "contact": {
        "nostr": <32 字节公钥的十六进制>,
        "phone": <字符串（可选）, 如果客户希望通过电话联系>,
        "email": <字符串（可选）, 如果客户希望通过电子邮件联系>,
    },
    "items": [
        {
            "product_id": <字符串, 产品的 UUID>,
            "quantity": <整数, 客户订购的产品数量>
        }
    ],
    "shipping_id": <字符串, 物流区域的 UUID>
}
```

_开放问题_：`contact.nostr` 是否必需？

### 步骤 2：`商家`请求付款（事件）

商家发回付款请求。商家可以检查的任何付款选项都是有效的。

以下 json 放在 [NIP04](https://github.com/nostr-protocol/nips/blob/master/04.md) 的 `content` 中。

`payment_options`/`type` 包括：

- `url` 支付页面的 URL，如 stripe，paypal，btcpayserver 等
- `btc` 在链比特币地址
- `ln` 比特币闪电发票
- `lnurl` 比特币 lnurl-pay

```json
{
    "id": <字符串, 订单的 UUID>,
    "type": 1,
    "message": <字符串, 给客户的消息, 可选>,
    "payment_options": [
        {
            "type": <字符串, 选项类型>,
            "link": <字符串, url, 比特币地址, 闪电网络发票, 等等>
        },
        {
            "type": <字符串, 选项类型>,
            "link": <字符串, url, 比特币地址, 闪电网络发票, 等等>
        },
        {
            "type": <字符串, 选项类型>,
            "link": <字符串, url, 比特币地址, 闪电网络发票, 等等>
        }
    ]
}
```

### 步骤 3：`商家`验证付款/已发货（事件）

一旦收到并处理了付款。

以下 json 放在 [NIP04](https://github.com/nostr-protocol/nips/blob/master/04.md) 的 `content` 中。

```json
{
    "id": <字符串, 订单的 UUID>,
    "type": 2,
    "message": <字符串, 给客户的消息>,
    "paid": <布尔值, 是否已收到付款>,
    "shipped": <布尔值, 是否已发货>,
}
```

## 自定义市场

使用 [NIP-19](https://github.com/nostr-protocol/nips/blob/master/19.md#shareable-identifiers-with-extra-metadata) 中的 `naddr` 创建定制的用户体验。`naddr` 的使用使得在包含丰富的元数据的同时，可以轻松分享市场事件。这些元数据可以包括中继，商家资料等。随后，它允许将商家分组到一个市场中，使市场创建者能够配置市场的用户界面和用户体验，并分享该市场。这种定制可以包括市场名称，描述，标志，横幅，主题，甚至颜色方案等元素，提供定制和独特的市场体验。

### 事件 `30019`：创建或更新市场 UI/UX

**事件内容**：

```json
{
        "name": <字符串（可选）, 市场名称>,
        "about": <字符串（可选）, 市场描述>,
        "ui": {
            "picture": <字符串（可选）, 市场标志图片 URL>,
            "banner": <字符串（可选）, 市场标志横幅 URL>,
            "theme": <字符串（可选）, 市场主题>,
            "darkMode": <布尔值, 真/假>
        },
        "merchants": <[字符串]（可选）, 公钥数组>,
        ...
}
```

此事件利用 naddr 来实现市场配置的全面定制和共享，从而营造出独特且引人入胜的市场环境。

## 客户支持事件

客户支持通过指定的通信方法进行处理。如果通过 nostr 进行通信，使用 NIP-04 https://github.com/nostr-protocol/nips/blob/master/04.md。

## 其他

标准数据模型可以在<a href="https://raw.githubusercontent.com/lnbits/nostrmarket/main/models.py">这里</a>找到
