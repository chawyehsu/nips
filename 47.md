NIP-47
======

Nostr 钱包连接
--------------

`草案` `可选` `作者:kiwiidb` `作者:bumi` `作者:semisol` `作者:vitorpamplona`

## 原理

此 NIP 描述了客户端通过标准化协议访问远程 Lightning 钱包的方式。托管钱包可以实现此协议，或者用户可以运行一个桥来桥接他们的钱包/节点和 Nostr 钱包连接协议。

## 术语

* **客户端**：任何平台上希望支付 Lightning 发票的 Nostr 应用程序。
* **用户**：使用**客户端**的人，并希望将他们的钱包应用程序连接到他们的**客户端**。
* **钱包服务**：通常在始终开启的计算机上运行的 Nostr 应用程序（例如，在云中或在 Raspberry Pi 上）。此应用程序可以访问其服务的钱包的 API。

## 操作理论

 1. 希望使用此 NIP 向其他 nostr 用户发送 lightning 支付的**用户**首先必须从他们的符合 NIP-47 的钱包应用程序获取一个特殊的“连接” URI。钱包应用程序可以使用 QR 屏幕，或可粘贴的字符串，或其他方式提供此 URI。
 
 2. **用户**应将此 URI 复制到他们的**客户端**中，通过粘贴，或扫描 QR 等。**客户端**应保存此 URI，并在**用户**进行付款时稍后使用它。然后，**客户端**应从 URI 中指定的中继请求一个 `info`（13194）事件。**钱包服务**早已将该事件发送给这些中继，而中继会将其保存为可替换事件。
 
 3. 当**用户**启动付款时，他们的 nostr **客户端**创建一个 `pay_invoice` 请求，使用 URI 中的令牌对其进行加密，并将其（kind 23194）发送到连接 URI 中指定的中继。**钱包服务**将在这些中继上监听，并将解密请求，然后联系**用户**的钱包应用程序发送付款。**钱包服务**将知道如何与钱包应用程序通信，因为连接 URI 指定了可以访问钱包应用程序 API 的中继。
 
 4. 付款完成后，**钱包服务**将通过 URI 中的中继向**用户**发送加密的 `response`（kind 23195）。

## 事件

有三种事件类型：
- `NIP-47 信息事件`：13194
- `NIP-47 请求`：23194
- `NIP-47 响应`：23195

信息事件应该是由**钱包服务**在中继上发布的可替换事件，以指示它支持哪些命令。内容应该是一个明文字符串，其中包含支持的命令，用空格分隔，例如 `pay_invoice get_balance`。只有 `pay_invoice` 命令在此 NIP 中描述，但其他命令可能在不同的 NIP 中定义。

请求和响应事件都**应该**包含一个 `p` 标签，如果这是一个请求，则包含**钱包服务**的公钥，如果这是一个响应，则包含**用户**的公钥。响应事件**应该**包含一个 `e` 标签，其中包含它正在响应的请求事件的 id。

请求和响应的内容使用 [NIP04](https://github.com/nostr-protocol/nips/blob/master/04.md) 加密，并且是具有半确定结构的 JSON-RPC 对象：

请求：

```jsonc
{
    "method": "pay_invoice", // method, string
    "params": { // params, object
        "invoice": "lnbc50n1..." // command-related data
    }
}
```

响应：

```jsonc
{
    "result_type": "pay_invoice", //indicates the structure of the result field
    "error": { //object, non-null in case of error
        "code": "UNAUTHORIZED", //string error code, see below
        "message": "human readable error message"
    },
    "result": { // result, object. null in case of error.
        "preimage": "0123456789abcdef..." // command-related data
    }
}
```

`result_type` 字段**必须**包含此事件正在响应的方法的名称。
如果命令未成功，`error` 字段**必须**包含一个带有人类可读错误消息的 `message` 字段和一个带有错误代码的 `code` 字段。
如果命令成功，`error` 字段**必须**为 null。

### 错误代码

- `RATE_LIMITED`：客户端发送命令的速度过快。应在几秒钟后重试。
- `NOT_IMPLEMENTED`：命令未知或故意未实现。
- `INSUFFICIENT_BALANCE`：钱包没有足够的资金来支付费用储备或付款金额。
- `QUOTA_EXCEEDED`：钱包已超出其支出配额。
- `RESTRICTED`：此公钥不允许进行此操作。
- `UNAUTHORIZED`：此公钥没有连接的钱包。
- `INTERNAL`：内部错误。
- `OTHER`：其他错误。

## Nostr 钱包连接 URI

**客户端**通过扫描二维码，处理 deeplink 或粘贴 URI 来发现**钱包服务**。

**钱包服务**生成此连接 URI，协议为 `nostr+walletconnect:`，基本路径为其十六进制编码的 `pubkey`，带有以下查询字符串参数：

- `relay` 必需。**钱包服务**连接并将监听事件的中继的 URL。可能有不止一个。
- `secret` 必需。32 字节随机生成的十六进制编码字符串。**客户端****必须**在与**钱包服务**通信时使用此密钥来签名事件和加密有效载荷。
    - 授权不需要来回传递密钥。
    - 用户可以为不同的应用程序使用不同的密钥。密钥可以随意撤销和创建，并具有任意约束（例如预算）。
    - 密钥更难泄露，因为它不会显示给用户和备份。
    - 它提高了隐私，因为用户的主密钥不会与他们的付款相关联。
- `lud16` 推荐。客户端可以使用的闪电地址，如果他们没有配置，可以自动在用户的配置文件上设置 `lud16` 字段。

然后，**客户端**应存储此连接，并在用户想要执行诸如支付发票之类的操作时使用它。由于此 NIP 使用临时事件，建议选择不会因不活动而关闭连接的中继，以免丢失事件。


### 链接字符串示例

```sh
nostr+walletconnect:b889ff5b1513b641e2a139f661a661364979c5beee91842f8f0ef42ab558e9d4?relay=wss%3A%2F%2Frelay.damus.io&secret=71a8c14c1407c113601079c4302dab36460f0ccd0ad506f1f2dc73b5100e4f3c
```

## 命令

### `pay_invoice`

描述：请求支付发票。

请求：

```jsonc
{
    "method": "pay_invoice",
    "params": {
        "invoice": "lnbc50n1..." // bolt11 invoice
    }
}
```

响应：

```jsonc
{
    "result_type": "pay_invoice",
    "result": { 
        "preimage": "0123456789abcdef..." // preimage of the payment
    }
}
```

错误：
- `PAYMENT_FAILED`：付款失败。这可能是由于超时，耗尽所有路由，容量不足等原因。

## 支付发票示例流程

0. 用户使用他们的**客户端**应用程序扫描**钱包服务**生成的二维码，他们遵循 `nostr+walletconnect:` deeplink 或手动配置连接详细信息。
1. **客户端**向**钱包服务**发送一种 `23194` 类型的事件。内容是 `pay_invoice` 请求。私钥是上述连接字符串中的秘密。
2. **钱包服务**验证作者的密钥是否有权进行付款，解密有效载荷并发送付款。
3. **钱包服务**通过发送一种 `23195` 类型的事件并且内容是响应来响应事件，该响应要么包含错误消息，要么包含预映像。

## 使用专用中继

此 NIP 并未规定使用何种类型的中继。然而，如果用户正在使用托管服务，那么使用由托管服务托管的中继可能是有意义的。然后，中继可以强制进行身份验证以防止元数据泄漏。在这种情况下，不依赖第三方中继也会提高可靠性。
