NIP-42
======

客户端对中继的认证
------------------

`草案` `可选` `作者:Semisol` `作者:fiatjaf`

此 NIP 定义了客户端通过签署临时事件来对中继进行认证的方式。

## 动机

中继可能希望要求客户端进行认证以访问受限资源。例如，

  - 中继可能要求付款或其他形式的白名单来发布事件 -- 这可以通过限制只有白名单密钥签署的事件才能发布来简单实现，但是有了这个 NIP，他们可以选择接受任何事件，只要它们是从经过认证的用户发布的；
  - 中继可能限制对 `kind: 4` 私信的访问，只允许参与聊天交流的双方访问，为此，它可能需要在客户端查询该类型之前进行认证。
  - 中继可能将任何类型的订阅限制给付费用户或通过任何其他方式列入白名单的用户，并要求认证。

## 定义

此 NIP 定义了一个新的消息，`AUTH`，当中继支持认证时，它们可以发送此消息，当客户端想要进行认证时，它们可以向中继发送此消息。当由中继发送时，消息的形式如下：

```
["AUTH", <challenge-string>]
```

当由客户端发送时，消息的形式如下：

```
["AUTH", <signed-event-json>]
```

签名的事件是一个临时事件，不应被发布或查询，它必须是 `kind: 22242`，并且应至少有两个标签，一个用于中继 URL，一个用于从中继接收的挑战字符串。中继**必须**排除 `kind: 22242` 事件，不向任何客户端广播。`created_at` 应为当前时间。例如：

```json
{
  "id": "...",
  "pubkey": "...",
  "created_at": 1669695536,
  "kind": 22242,
  "tags": [
    ["relay", "wss://relay.example.com/"],
    ["challenge", "challengestringhere"]
  ],
  "content": "",
  "sig": "..."
}
```

## 协议流程

在任何时候，中继都可以向客户端发送一个包含挑战的 `AUTH` 消息。收到后，客户端可以决定是否进行身份验证。挑战预计在连接持续期间或直到中继发送下一个挑战时都有效。

客户端可能在执行需要身份验证的操作之前立即发送认证消息 -- 例如在请求 `kind: 4` 聊天消息之前 -- 或者它可能在连接开始时或在其认为最好的某个时刻进行。认证预计将持续到 WebSocket 连接的持续时间。

在收到一个未经认证的用户的消息时，如果没有认证就无法完成，中继可以选择通知客户端。为此，它可以使用带有标准前缀 `"restricted: "` 的 `NOTICE` 或 `OK` 消息，这个前缀既可供人类阅读，也可供机器阅读，例如：

```
["NOTICE", "restricted: we can't serve DMs to unauthenticated users, does your client implement NIP-42?"]
```

或者，它可以返回一个 `OK` 消息，使用相同的前缀说明事件未被写入的原因：

```
["OK", <event-id>, false, "restricted: we do not accept events from unauthenticated users, please sign up at https://example.com/"]
```

## 签名事件验证

为了验证 `AUTH` 消息，中继必须确保：

  - `kind` 是 `22242`；
  - 事件的 `created_at` 与当前时间接近（例如，相差约 10 分钟内）；
  - `"challenge"` 标签与之前发送的挑战匹配；
  - `"relay"` 标签与中继 URL 匹配：
    - 可以应用 URL 规范化技术。在大多数情况下，只检查域名是否正确就足够了。
